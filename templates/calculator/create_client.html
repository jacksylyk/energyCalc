{% extends 'base.html' %}
{% block content %}
    <div class="flex gap-3 flex-col w-1/4  mx-auto p-4 pt-6 md:p-6 lg:p-12 bg-white rounded shadow-md">
        <div class="text-3xl font-semibold">Добавить клиента</div>
        <form method="post">
            {% csrf_token %}
            <div class="mb-6">
                <label for="id_name"
                       class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Наименование</label>
                <input type="text" id="id_name" name="name" maxlength="100" required value="{{ client.name }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="id_bin_number" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">БИН
                    номер:</label>
                <input type="text" id="id_bin_number" name="bin_number" maxlength="12" required
                       value="{{ client.bin_number }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="id_information" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Информация
                    ПКУ:</label>
                <input type="text" id="id_information" name="information" maxlength="256"
                       value="{{ client.information }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="id_contract_number" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Номер
                    договора:</label>
                <input type="text" id="id_contract_number" name="contract_number" maxlength="50"
                       required value="{{ client.contract_number }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <label for="id_contract_date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Дата
                акта:</label>
            <div class="relative w-full mb-6">
                <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                    </svg>
                </div>

                <input datepicker datepicker-format="dd.mm.yyyy" type="text" id="id_contract_date" name="contract_date"
                       autocomplete="off" value="{{ client.contract_date }}"
                       required
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5  dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                       placeholder="Выберите дату">
            </div>
            <div class="mb-6">
                <label for="id_location" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Местоположение
                    ПКУ:</label>
                <input type="text" id="id_location" name="location" maxlength="128" value="{{ client.location }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="id_address"
                       class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Юридический адрес:</label>
                <input type="text" id="id_address" name="address" maxlength="256" value="{{ client.address }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <div class="mb-6">
                <label for="id_consumer_group" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Группа
                    потребителей:</label>
                <select id="id_consumer_group" name="consumer_group"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    {% for choice in form.consumer_group.field.choices %}
                        {% if choice.0 == client.consumer_group %}
                            <option selected value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% else %}
                            <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="mb-6">
                <label for="id_notes"
                       class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Примечания:</label>
                <input type="text" id="id_notes" name="notes" maxlength="256" value="{{ client.notes }}"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
            </div>
            <!-- Contact formset -->
            <input type="hidden" name="contacts_array" id="contactsArrayInput">

            <div class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Контакты:</div>
            <table id="contactsTable" class="text-gray-500 w-full text-sm text-left">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">Телефон</th>
                    <th scope="col" class="px-6 py-3">Действие</th>
                </tr>
                </thead>
                <tbody>
                {% if client.contacts %}
                    {% for contact in client.contacts.all %}
                        <tr>
                            <td class="px-3 py-4">
                                <input type='text' value="{{ contact }}"
                                       class='bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500'>
                            </td>
                            <td>
                                <button onclick='deleteContact(this)'
                                        class='focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900'>
                                    Удалить
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td class="px-3 py-4">
                            <input type='text'
                                   class='bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500'>
                        </td>
                        <td>
                            <button onclick='deleteContact(this)'
                                    class='focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900'>
                                Удалить
                            </button>
                        </td>
                    </tr>
                {% endif %}


                </tbody>
            </table>
            <button onclick="addContact()" type="button"
                    class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">
                Добавить контакт
            </button>

            <div>
                <button type="submit" onclick="submitContacts()"
                        class="focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                    Сохранить
                </button>
            </div>
        </form>
    </div>

    <script>
        function addContact() {
            var table = document.getElementById("contactsTable").getElementsByTagName('tbody')[0];
            var row = table.insertRow(-1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            cell1.classList.add("px-3", "py-4");
            cell2.classList.add("px-3", "py-4");
            cell1.innerHTML = "<input type='text' class='bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500'>";
            cell2.innerHTML = "<button onclick='deleteContact(this)' class='focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900'>Удалить</button>";
        }

        function deleteContact(row) {
            var rowIndex = row.parentNode.parentNode.rowIndex;
            document.getElementById("contactsTable").deleteRow(rowIndex);
        }

        function submitContacts() {
            var table = document.getElementById("contactsTable");
            var contactsArray = [];
            for (var i = 1; i < table.rows.length; i++) {
                var contact = {
                    phone: table.rows[i].cells[0].getElementsByTagName("input")[0].value
                };
                contactsArray.push(contact);
            }
            document.getElementById("contactsArrayInput").value = JSON.stringify(contactsArray);
        }
    </script>
{% endblock content %}
